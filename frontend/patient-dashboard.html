<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - Jijue Hospital</title>
    <link rel="stylesheet" href="patient-dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
</head>
<body>
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="container header-container">
            <div class="logo">
                <span class="logo-icon">üè•</span>
                <h1>Jijue Hospital</h1>
            </div>
            <div class="patient-info">
                <div class="patient-welcome">
                    <h3 class="patient-name">Welcome, Loading...</h3>
                    <p class="patient-id">Patient ID: Loading...</p>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <div class="container">
        <div class="dashboard-container">
            <!-- Sidebar Navigation -->
            <div class="dashboard-sidebar sidebar-mobile-hidden">
                <h3 style="color: var(--primary); margin-bottom: 25px; font-size: 1.4rem; font-weight: 700;">Patient Dashboard</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('overview')">
                            <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('appointments')">
                            <span class="nav-icon"><i class="fas fa-calendar-alt"></i></span>
                            <span>Appointments</span>
                            <span class="notification-badge" id="appointments-badge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('medical-records')">
                            <span class="nav-icon"><i class="fas fa-file-medical"></i></span>
                            <span>Medical Records</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('lab-results')">
                            <span class="nav-icon"><i class="fas fa-flask"></i></span>
                            <span>Lab Results</span>
                            <span class="notification-badge" id="lab-results-badge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('prescriptions')">
                            <span class="nav-icon"><i class="fas fa-pills"></i></span>
                            <span>Prescriptions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('billing')">
                            <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                            <span>Billing</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('profile')">
                            <span class="nav-icon"><i class="fas fa-user"></i></span>
                            <span>Profile</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content Area -->
            <div class="dashboard-main">
                <!-- Overview Section -->
                <div id="overview" class="dashboard-section active">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div>
                                <h3>Dashboard Overview</h3>
                                <p>Welcome to your patient dashboard</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm" onclick="refreshDashboard()">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="quick-stats">
                            <div class="stat-card scroll-animate">
                                <div class="stat-number" id="upcoming-appointments">0</div>
                                <div class="stat-label">Upcoming Appointments</div>
                            </div>
                            <div class="stat-card scroll-animate">
                                <div class="stat-number" id="pending-results">0</div>
                                <div class="stat-label">Pending Results</div>
                            </div>
                            <div class="stat-card scroll-animate">
                                <div class="stat-number" id="active-prescriptions">0</div>
                                <div class="stat-label">Active Prescriptions</div>
                            </div>
                            <div class="stat-card scroll-animate">
                                <div class="stat-number" id="current-balance">$0.00</div>
                                <div class="stat-label">Current Balance</div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <h4 style="color: var(--primary); margin-bottom: 20px; font-size: 1.2rem;">Recent Appointments</h4>
                        <div class="appointment-list" id="recent-appointments">
                            <div class="no-data">Loading recent appointments...</div>
                        </div>
                    </div>
                    
                    <!-- Health Summary Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Health Summary</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="stat-card">
                                <div class="stat-number" style="color: var(--success);" id="blood-pressure">--/--</div>
                                <div class="stat-label">Blood Pressure</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" style="color: var(--success);" id="heart-rate">--</div>
                                <div class="stat-label">Heart Rate (bpm)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" style="color: var(--success);" id="temperature">--¬∞F</div>
                                <div class="stat-label">Temperature</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" style="color: var(--success);" id="bmi">--</div>
                                <div class="stat-label">BMI</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments Section -->
                <div id="appointments" class="dashboard-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Appointment Management</h3>
                            <button class="btn" onclick="bookAppointment()">
                                <i class="fas fa-plus"></i>
                                Book New Appointment
                            </button>
                        </div>
                        
                        <div class="appointment-list" id="appointments-list">
                            <div class="no-data">Loading appointments...</div>
                        </div>
                    </div>
                </div>

                <!-- Medical Records Section -->
                <div id="medical-records" class="dashboard-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Medical Records</h3>
                            <button class="btn" onclick="downloadMedicalRecordsPDF()">
                                <i class="fas fa-download"></i>
                                Download All Records (PDF)
                            </button>
                        </div>
                        
                        <div class="records-grid" id="medical-records-list">
                            <div class="no-data">Loading medical records...</div>
                        </div>
                    </div>
                </div>

                <!-- Lab Results Section -->
                <div id="lab-results" class="dashboard-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Laboratory Results</h3>
                            <button class="btn" onclick="requestLabWork()">
                                <i class="fas fa-plus"></i>
                                Request New Lab Work
                            </button>
                        </div>
                        
                        <div class="lab-results" id="lab-results-list">
                            <div class="no-data">Loading lab results...</div>
                        </div>
                    </div>
                </div>

                <!-- Prescriptions Section -->
                <div id="prescriptions" class="dashboard-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Prescription Management</h3>
                            <button class="btn" onclick="requestNewPrescription()">
                                <i class="fas fa-plus"></i>
                                Request New Prescription
                            </button>
                        </div>
                        
                        <div class="prescription-list" id="prescriptions-list">
                            <div class="no-data">Loading prescriptions...</div>
                        </div>
                    </div>
                </div>

                <!-- Billing Section -->
                <div id="billing" class="dashboard-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Billing & Payments</h3>
                            <button class="btn" onclick="showPaymentModal()">
                                <i class="fas fa-credit-card"></i>
                                Make Payment
                            </button>
                        </div>
                        
                        <!-- Billing Summary -->
                        <div class="billing-summary">
                            <div class="billing-card scroll-animate">
                                <div class="billing-amount" id="current-balance-billing">$0.00</div>
                                <div class="billing-label">Current Balance</div>
                            </div>
                            <div class="billing-card scroll-animate">
                                <div class="billing-amount" id="total-paid">$0.00</div>
                                <div class="billing-label">Total Paid This Year</div>
                            </div>
                            <div class="billing-card scroll-animate">
                                <div class="billing-amount" id="pending-claims">0</div>
                                <div class="billing-label">Pending Claims</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile" class="dashboard-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Profile Information</h3>
                            <button class="btn" onclick="editProfile()">
                                <i class="fas fa-edit"></i>
                                Edit Profile
                            </button>
                        </div>
                        
                        <div class="profile-info" id="profile-info">
                            <div class="no-data">Loading profile information...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Book New Appointment</h3>
                <span class="close" onclick="closeBookingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="booking-form">
                    <div class="form-group">
                        <label for="booking-department">Select Department</label>
                        <select id="booking-department" class="form-control" required>
                            <option value="">Select a department</option>
                            <!-- Departments will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="booking-doctor">Select Doctor (Optional)</label>
                        <select id="booking-doctor" class="form-control">
                            <option value="">Any available doctor</option>
                            <!-- Doctors will be loaded based on department selection -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="booking-date">Appointment Date</label>
                        <input type="text" id="booking-date" class="form-control" placeholder="YYYY/MM/DD" maxlength="10" required>
                    </div>
                    <div class="form-group">
                        <label for="booking-time">Appointment Time</label>
                        <select id="booking-time" class="form-control" required>
                            <option value="">Select time</option>
                            <option value="09:00">09:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="14:00">02:00 PM</option>
                            <option value="15:00">03:00 PM</option>
                            <option value="16:00">04:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="booking-type">Appointment Type</label>
                        <select id="booking-type" class="form-control" required>
                            <option value="consultation">Consultation</option>
                            <option value="follow-up">Follow-up</option>
                            <option value="checkup">Checkup</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="booking-consultation-type">Consultation Type</label>
                        <select id="booking-consultation-type" class="form-control" required>
                            <option value="in-person">In-Person</option>
                            <option value="online">Online</option>
                            <option value="phone">Phone</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="booking-reason">Reason for Visit</label>
                        <textarea id="booking-reason" class="form-control" rows="3" placeholder="Please describe your symptoms or reason for visit..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="booking-symptoms">Symptoms (comma separated)</label>
                        <input type="text" id="booking-symptoms" class="form-control" placeholder="e.g., headache, fever, cough">
                    </div>
                    <div class="form-group">
                        <label for="booking-priority">Priority</label>
                        <select id="booking-priority" class="form-control">
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="high">High</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Book Appointment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Make Payment</h3>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="payment-form">
                    <div class="form-group">
                        <label for="payment-amount">Amount to Pay ($)</label>
                        <input type="number" id="payment-amount" class="form-control" min="1" step="0.01" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="payment-method">Payment Method</label>
                        <select id="payment-method" class="form-control" required>
                            <option value="">Select payment method</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="debit_card">Debit Card</option>
                            <option value="mpesa">M-Pesa</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>
                    <div id="card-details" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card-number">Card Number</label>
                                <input type="text" id="card-number" class="form-control" placeholder="1234 5678 9012 3456">
                            </div>
                            <div class="form-group">
                                <label for="card-expiry">Expiry Date</label>
                                <input type="text" id="card-expiry" class="form-control" placeholder="MM/YY">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card-cvv">CVV</label>
                                <input type="text" id="card-cvv" class="form-control" placeholder="123">
                            </div>
                            <div class="form-group">
                                <label for="card-name">Name on Card</label>
                                <input type="text" id="card-name" class="form-control" placeholder="John Doe">
                            </div>
                        </div>
                    </div>
                    <div id="mpesa-details" style="display: none;">
                        <div class="form-group">
                            <label for="mpesa-phone">M-Pesa Phone Number</label>
                            <input type="tel" id="mpesa-phone" class="form-control" placeholder="07XX XXX XXX">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Process Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <span class="close" onclick="closeModal('profile-edit-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-firstName">First Name</label>
                            <input type="text" id="edit-firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-lastName">Last Name</label>
                            <input type="text" id="edit-lastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-phone">Phone</label>
                            <input type="tel" id="edit-phone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-dateOfBirth">Date of Birth</label>
                            <input type="text" id="edit-dateOfBirth" class="form-control" placeholder="YYYY/MM/DD" maxlength="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-address">Address</label>
                        <input type="text" id="edit-address" class="form-control">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-city">City</label>
                            <input type="text" id="edit-city" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-postalCode">Postal Code</label>
                            <input type="text" id="edit-postalCode" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-allergies">Allergies</label>
                        <input type="text" id="edit-allergies" class="form-control" placeholder="e.g., Penicillin, Peanuts">
                    </div>
                    <div class="form-group">
                        <label for="edit-bloodType">Blood Type</label>
                        <select id="edit-bloodType" class="form-control">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('profile-edit-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

   <script>
        // Configuration
const API_BASE = 'http://localhost:5000/api';

// Global variables
let currentPatient = null;
let authToken = null;
let availableDepartments = [];

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard initializing...');
    initializeDashboard();
    setupEventListeners();
});

function setupEventListeners() {
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        const modals = ['booking-modal', 'profile-edit-modal', 'payment-modal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && event.target === modal) {
                closeModal(modalId);
            }
        });
    });

    // Escape key to close modals
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal('booking-modal');
            closeModal('profile-edit-modal');
            closeModal('payment-modal');
        }
    });

    // Form submissions
    const bookingForm = document.getElementById('booking-form');
    if (bookingForm) {
        bookingForm.addEventListener('submit', handleBookingSubmit);
    }

    // Department selection change
    const departmentSelect = document.getElementById('booking-department');
    if (departmentSelect) {
        departmentSelect.addEventListener('change', handleDepartmentChange);
    }

    // Payment method change
    const paymentMethod = document.getElementById('payment-method');
    if (paymentMethod) {
        paymentMethod.addEventListener('change', handlePaymentMethodChange);
    }

    // Payment form submission
    const paymentForm = document.getElementById('payment-form');
    if (paymentForm) {
        paymentForm.addEventListener('submit', handlePaymentSubmit);
    }

    // Enhanced date input formatting with automatic slashes
    const bookingDateInput = document.getElementById('booking-date');
    if (bookingDateInput) {
        bookingDateInput.addEventListener('input', formatDateInput);
        bookingDateInput.addEventListener('keydown', handleDateKeydown);
    }

    const dobInput = document.getElementById('edit-dateOfBirth');
    if (dobInput) {
        dobInput.addEventListener('input', formatDateInput);
        dobInput.addEventListener('keydown', handleDateKeydown);
    }
}

// Enhanced date input formatting with automatic slashes
function formatDateInput(event) {
    const input = event.target;
    let value = input.value.replace(/\D/g, '');
    
    // Remove existing slashes for processing
    value = value.replace(/\//g, '');
    
    // Limit to 8 digits (YYYYMMDD)
    if (value.length > 8) {
        value = value.substring(0, 8);
    }
    
    // Add slashes automatically as user types
    let formattedValue = value;
    if (value.length > 4) {
        formattedValue = value.substring(0, 4) + '/' + value.substring(4);
    }
    if (value.length > 6) {
        formattedValue = formattedValue.substring(0, 7) + '/' + formattedValue.substring(7);
    }
    
    input.value = formattedValue;
    
    // Basic validation - check if we have a complete date
    if (value.length === 8) {
        validateDate(input, value);
    }
}

// Handle special keys for date input (backspace, delete, etc.)
function handleDateKeydown(event) {
    const input = event.target;
    const cursorPosition = input.selectionStart;
    
    // If backspace is pressed on a slash, remove the character before the slash
    if (event.key === 'Backspace' && input.value[cursorPosition - 1] === '/') {
        event.preventDefault();
        const value = input.value;
        const newValue = value.substring(0, cursorPosition - 2) + value.substring(cursorPosition);
        input.value = newValue;
        input.setSelectionRange(cursorPosition - 2, cursorPosition - 2);
        
        // Reformat the date
        setTimeout(() => {
            const inputEvent = new Event('input', { bubbles: true });
            input.dispatchEvent(inputEvent);
        }, 0);
    }
    
    // If delete is pressed on a slash, remove the character after the slash
    if (event.key === 'Delete' && input.value[cursorPosition] === '/') {
        event.preventDefault();
        const value = input.value;
        const newValue = value.substring(0, cursorPosition + 1) + value.substring(cursorPosition + 2);
        input.value = newValue;
        input.setSelectionRange(cursorPosition, cursorPosition);
        
        // Reformat the date
        setTimeout(() => {
            const inputEvent = new Event('input', { bubbles: true });
            input.dispatchEvent(inputEvent);
        }, 0);
    }
}

function validateDate(input, rawValue) {
    const year = parseInt(rawValue.substring(0, 4));
    const month = parseInt(rawValue.substring(4, 6));
    const day = parseInt(rawValue.substring(6, 8));
    
    const currentYear = new Date().getFullYear();
    
    // Basic validation
    if (year < 1900 || year > currentYear + 1) {
        input.style.borderColor = 'var(--danger)';
        showInputError(input, 'Please enter a valid year (1900-' + (currentYear + 1) + ')');
        return false;
    }
    
    if (month < 1 || month > 12) {
        input.style.borderColor = 'var(--danger)';
        showInputError(input, 'Please enter a valid month (01-12)');
        return false;
    }
    
    // Check day validity based on month
    const daysInMonth = new Date(year, month, 0).getDate();
    if (day < 1 || day > daysInMonth) {
        input.style.borderColor = 'var(--danger)';
        showInputError(input, 'Please enter a valid day for ' + month + '/' + year);
        return false;
    }
    
    // Check if date is in the past (for appointment dates)
    if (input.id === 'booking-date') {
        const selectedDate = new Date(year, month - 1, day);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            input.style.borderColor = 'var(--warning)';
            showInputError(input, 'Appointment date cannot be in the past');
            return false;
        }
    }
    
    // Valid date
    input.style.borderColor = 'var(--success)';
    hideInputError(input);
    return true;
}

function showInputError(input, message) {
    // Remove existing error
    hideInputError(input);
    
    // Create error element
    const errorElement = document.createElement('div');
    errorElement.className = 'input-error';
    errorElement.style.cssText = `
        color: var(--danger);
        font-size: 0.8rem;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    `;
    errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    
    input.parentNode.appendChild(errorElement);
}

function hideInputError(input) {
    const existingError = input.parentNode.querySelector('.input-error');
    if (existingError) {
        existingError.remove();
    }
}

function handlePaymentMethodChange() {
    const method = this.value;
    document.getElementById('card-details').style.display = method === 'credit_card' || method === 'debit_card' ? 'block' : 'none';
    document.getElementById('mpesa-details').style.display = method === 'mpesa' ? 'block' : 'none';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

async function initializeDashboard() {
    try {
        console.log('üîç Checking authentication...');
        
        // Check if patient is logged in
        currentPatient = JSON.parse(localStorage.getItem('currentPatient'));
        authToken = localStorage.getItem('authToken');
        
        if (!currentPatient || !authToken) {
            console.log('‚ùå No authentication found, redirecting to portal');
            window.location.href = 'patient-portal.html';
            return;
        }

        console.log('‚úÖ Patient authenticated:', currentPatient.patientId);

        // Initialize mobile menu
        initMobileMenu();
        
        // Update patient info in header
        updatePatientHeader();
        
        // Load initial data
        await loadOverviewData();
        
        // Initialize scroll animations
        triggerScrollAnimations();
        
        console.log('‚úÖ Dashboard initialized successfully');

    } catch (error) {
        console.error('‚ùå Dashboard initialization error:', error);
        showNotification('Error initializing dashboard. Please refresh the page.', 'error');
    }
}

function updatePatientHeader() {
    const patientName = document.querySelector('.patient-name');
    const patientId = document.querySelector('.patient-id');
    
    if (patientName) patientName.textContent = `Welcome, ${currentPatient.firstName} ${currentPatient.lastName}`;
    if (patientId) patientId.textContent = `Patient ID: ${currentPatient.patientId}`;
}

// Section Management
function showSection(sectionId) {
    console.log('üìÇ Switching to section:', sectionId);
    
    // Hide all sections
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Add active class to clicked nav link
    event.currentTarget.classList.add('active');
    
    // Load section data from API
    loadSectionData(sectionId);
    
    // Trigger scroll animations for new content
    setTimeout(() => {
        triggerScrollAnimations();
    }, 100);
}

async function loadSectionData(sectionId) {
    try {
        console.log('üì• Loading section data:', sectionId);
        showLoading(sectionId);
        
        switch(sectionId) {
            case 'overview':
                await loadOverviewData();
                break;
            case 'appointments':
                await loadAppointmentsData();
                break;
            case 'medical-records':
                await loadMedicalRecords();
                break;
            case 'lab-results':
                await loadLabResults();
                break;
            case 'prescriptions':
                await loadPrescriptions();
                break;
            case 'billing':
                await loadBillingData();
                break;
            case 'profile':
                await loadProfileData();
                break;
        }
        console.log('‚úÖ Section data loaded:', sectionId);
    } catch (error) {
        console.error(`‚ùå Error loading ${sectionId}:`, error);
        showError(sectionId, 'Failed to load data. Please try again.');
    }
}

function showLoading(sectionId) {
    let container;
    
    switch(sectionId) {
        case 'overview':
            container = document.getElementById('recent-appointments');
            break;
        case 'appointments':
            container = document.getElementById('appointments-list');
            break;
        case 'medical-records':
            container = document.getElementById('medical-records-list');
            break;
        case 'lab-results':
            container = document.getElementById('lab-results-list');
            break;
        case 'prescriptions':
            container = document.getElementById('prescriptions-list');
            break;
        case 'billing':
            container = document.getElementById('billing-history');
            break;
        case 'profile':
            container = document.getElementById('profile-info');
            break;
    }
    
    if (container) {
        container.innerHTML = `
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading...</p>
            </div>
        `;
    }
}

// Load overview data from API
async function loadOverviewData() {
    try {
        console.log('üìä Loading overview data from:', `${API_BASE}/patients/${currentPatient.patientId}/overview`);
        
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/overview`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Overview response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üì¶ Overview response data:', result);

        if (result.success) {
            updateOverviewUI(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('‚ùå Error loading overview:', error);
        // Set default values
        updateOverviewUI({
            upcomingAppointments: 0,
            pendingResults: 0,
            activePrescriptions: 0,
            currentBalance: 0,
            recentAppointments: []
        });
    }
}

function updateOverviewUI(data) {
    console.log('üéØ Updating overview UI with data:', data);
    
    // Update quick stats
    const stats = {
        'upcoming-appointments': data.upcomingAppointments || 0,
        'pending-results': data.pendingResults || 0,
        'active-prescriptions': data.activePrescriptions || 0,
        'current-balance': `$${(data.currentBalance || 0).toFixed(2)}`
    };

    Object.entries(stats).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
            element.classList.add('pulse-animation');
            setTimeout(() => element.classList.remove('pulse-animation'), 600);
        }
    });
    
    // Update notification badges
    const appointmentsBadge = document.getElementById('appointments-badge');
    const labResultsBadge = document.getElementById('lab-results-badge');
    
    if (appointmentsBadge) {
        appointmentsBadge.textContent = data.upcomingAppointments || 0;
        appointmentsBadge.style.display = data.upcomingAppointments > 0 ? 'flex' : 'none';
    }
    if (labResultsBadge) {
        labResultsBadge.textContent = data.pendingResults || 0;
        labResultsBadge.style.display = data.pendingResults > 0 ? 'flex' : 'none';
    }
    
    // Update recent appointments
    const container = document.getElementById('recent-appointments');
    if (data.recentAppointments && data.recentAppointments.length > 0) {
        container.innerHTML = data.recentAppointments.map(apt => `
            <div class="appointment-item scroll-animate">
                <div class="appointment-info">
                    <h4>${apt.type || 'Appointment'} - ${apt.consultationType || 'In-person'}</h4>
                    <p><i class="fas fa-user-md"></i> ${apt.doctor?.name || 'Doctor'} ‚Ä¢ ${formatDate(apt.date)} at ${formatTime(apt.time)}</p>
                    <p><i class="fas fa-stethoscope"></i> ${apt.reason || 'General Consultation'}</p>
                </div>
                <span class="appointment-status status-${apt.status}">${apt.status}</span>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<div class="no-data">No upcoming appointments</div>';
    }
    
    // Load health metrics
    loadHealthMetrics();
}

async function loadHealthMetrics() {
    try {
        console.log('‚ù§Ô∏è Loading health metrics...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/health-metrics`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.data) {
                // Update health summary cards
                document.getElementById('blood-pressure').textContent = result.data.bloodPressure || '--/--';
                document.getElementById('heart-rate').textContent = result.data.heartRate || '--';
                document.getElementById('temperature').textContent = result.data.temperature ? `${result.data.temperature}¬∞F` : '--¬∞F';
                document.getElementById('bmi').textContent = result.data.bmi || '--';
            }
        }
    } catch (error) {
        console.error('‚ùå Error loading health metrics:', error);
    }
}

// Load appointments from API
async function loadAppointmentsData() {
    try {
        console.log('üìÖ Loading appointments data...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/appointments`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Appointments response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üì¶ Appointments response data:', result);
        
        if (result.success) {
            updateAppointmentsUI(result.appointments || []);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('‚ùå Error loading appointments:', error);
        showError('appointments-list', 'Failed to load appointments.');
    }
}

function updateAppointmentsUI(appointments) {
    const container = document.getElementById('appointments-list');
    if (!container) return;

    console.log('üéØ Updating appointments UI with:', appointments?.length || 0, 'appointments');

    if (!appointments || appointments.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-calendar-times"></i>
                <h3>No Appointments Found</h3>
                <p>You don't have any appointments scheduled.</p>
            </div>
        `;
        return;
    }

    // Group appointments by status
    const upcoming = appointments.filter(apt => ['scheduled', 'confirmed'].includes(apt.status));
    const completed = appointments.filter(apt => ['completed', 'checked-in'].includes(apt.status));
    const cancelled = appointments.filter(apt => apt.status === 'cancelled');

    container.innerHTML = `
        ${upcoming.length > 0 ? `
            <div class="appointment-group">
                <h3 class="group-title">Upcoming Appointments (${upcoming.length})</h3>
                ${upcoming.map(apt => createAppointmentCard(apt)).join('')}
            </div>
        ` : ''}
        
        ${completed.length > 0 ? `
            <div class="appointment-group">
                <h3 class="group-title">Past Appointments (${completed.length})</h3>
                ${completed.map(apt => createAppointmentCard(apt)).join('')}
            </div>
        ` : ''}
        
        ${cancelled.length > 0 ? `
            <div class="appointment-group">
                <h3 class="group-title">Cancelled Appointments (${cancelled.length})</h3>
                ${cancelled.map(apt => createAppointmentCard(apt)).join('')}
            </div>
        ` : ''}
    `;
}

function createAppointmentCard(apt) {
    return `
        <div class="appointment-card scroll-animate" data-appointment-id="${apt._id}">
            <div class="appointment-header">
                <h4>${apt.type || 'Appointment'} #${apt.appointmentId || apt._id?.slice(-6) || 'N/A'}</h4>
                <span class="status-badge status-${apt.status}">${apt.status}</span>
            </div>
            <div class="appointment-details">
                <div class="detail-item">
                    <i class="fas fa-user-md"></i>
                    <span>${apt.doctor?.name || 'Doctor'}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-calendar"></i>
                    <span>${formatDate(apt.date)} at ${formatTime(apt.time)}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-info-circle"></i>
                    <span>${apt.type || 'Consultation'} - ${apt.consultationType || 'In-person'}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-comment-medical"></i>
                    <span>${apt.reason || 'General Consultation'}</span>
                </div>
            </div>
            <div class="appointment-actions">
                ${['scheduled', 'confirmed'].includes(apt.status) ? `
                    <button class="btn btn-outline btn-sm" onclick="rescheduleAppointment('${apt._id}')">
                        <i class="fas fa-calendar-alt"></i> Reschedule
                    </button>
                    <button class="btn btn-outline btn-sm btn-danger" onclick="cancelAppointment('${apt._id}')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

// Profile Management
async function loadProfileData() {
    try {
        console.log('üë§ Loading profile data...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/profile`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Profile response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üì¶ Profile response data:', result);
        
        if (result.success && result.patient) {
            updateProfileUI(result.patient);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('‚ùå Error loading profile:', error);
        showError('profile-info', 'Failed to load profile information.');
    }
}

function updateProfileUI(patient) {
    const container = document.getElementById('profile-info');
    
    container.innerHTML = `
        <div class="profile-details">
            <div class="profile-section">
                <h4>Personal Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Full Name:</label>
                        <span>${patient.firstName} ${patient.lastName}</span>
                    </div>
                    <div class="detail-item">
                        <label>Patient ID:</label>
                        <span>${patient.patientId}</span>
                    </div>
                    <div class="detail-item">
                        <label>Date of Birth:</label>
                        <span>${formatDate(patient.dateOfBirth)}</span>
                    </div>
                    <div class="detail-item">
                        <label>Gender:</label>
                        <span>${patient.gender || 'Not specified'}</span>
                    </div>
                    <div class="detail-item">
                        <label>Phone:</label>
                        <span>${patient.phone || 'Not provided'}</span>
                    </div>
                    <div class="detail-item">
                        <label>Email:</label>
                        <span>${patient.email}</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <h4>Address Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Address:</label>
                        <span>${patient.address || 'Not provided'}</span>
                    </div>
                    <div class="detail-item">
                        <label>City:</label>
                        <span>${patient.city || 'Not provided'}</span>
                    </div>
                    <div class="detail-item">
                        <label>Postal Code:</label>
                        <span>${patient.postalCode || 'Not provided'}</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <h4>Medical Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Blood Type:</label>
                        <span>${patient.bloodType || 'Not specified'}</span>
                    </div>
                    <div class="detail-item">
                        <label>Allergies:</label>
                        <span>${patient.allergies || 'None reported'}</span>
                    </div>
                    <div class="detail-item">
                        <label>Emergency Contact:</label>
                        <span>${patient.emergencyContact?.name || 'Not provided'} ${patient.emergencyContact?.phone ? `(${patient.emergencyContact.phone})` : ''}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function editProfile() {
    showProfileEditModal();
}

function showProfileEditModal() {
    // Create modal if it doesn't exist
    if (!document.getElementById('profile-edit-modal')) {
        const modalHTML = `
            <div id="profile-edit-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Profile</h3>
                        <span class="close" onclick="closeModal('profile-edit-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-firstName">First Name</label>
                                    <input type="text" id="edit-firstName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-lastName">Last Name</label>
                                    <input type="text" id="edit-lastName" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-phone">Phone</label>
                                    <input type="tel" id="edit-phone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="edit-dateOfBirth">Date of Birth</label>
                                    <input type="text" id="edit-dateOfBirth" class="form-control" placeholder="YYYY/MM/DD" maxlength="10">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="edit-address">Address</label>
                                <input type="text" id="edit-address" class="form-control">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-city">City</label>
                                    <input type="text" id="edit-city" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="edit-postalCode">Postal Code</label>
                                    <input type="text" id="edit-postalCode" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="edit-allergies">Allergies</label>
                                <input type="text" id="edit-allergies" class="form-control" placeholder="e.g., Penicillin, Peanuts">
                            </div>
                            <div class="form-group">
                                <label for="edit-bloodType">Blood Type</label>
                                <select id="edit-bloodType" class="form-control">
                                    <option value="">Select Blood Type</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="Unknown">Unknown</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('profile-edit-modal')">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Add form submission handler
        document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
    }

    // Load current data into form
    loadProfileFormData();
    
    // Show modal
    document.getElementById('profile-edit-modal').style.display = 'block';
}

async function loadProfileFormData() {
    try {
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/profile`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success && result.patient) {
                const patient = result.patient;
                
                document.getElementById('edit-firstName').value = patient.firstName || '';
                document.getElementById('edit-lastName').value = patient.lastName || '';
                document.getElementById('edit-phone').value = patient.phone || '';
                document.getElementById('edit-dateOfBirth').value = patient.dateOfBirth ? formatDate(patient.dateOfBirth) : '';
                document.getElementById('edit-address').value = patient.address || '';
                document.getElementById('edit-city').value = patient.city || '';
                document.getElementById('edit-postalCode').value = patient.postalCode || '';
                document.getElementById('edit-allergies').value = patient.allergies || '';
                document.getElementById('edit-bloodType').value = patient.bloodType || '';
            }
        }
    } catch (error) {
        console.error('Error loading profile form data:', error);
    }
}

async function handleProfileUpdate(event) {
    event.preventDefault();
    
    const formData = {
        firstName: document.getElementById('edit-firstName').value,
        lastName: document.getElementById('edit-lastName').value,
        phone: document.getElementById('edit-phone').value,
        dateOfBirth: document.getElementById('edit-dateOfBirth').value,
        address: document.getElementById('edit-address').value,
        city: document.getElementById('edit-city').value,
        postalCode: document.getElementById('edit-postalCode').value,
        allergies: document.getElementById('edit-allergies').value,
        bloodType: document.getElementById('edit-bloodType').value
    };

    try {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;

        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/profile`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        console.log('üì¶ Profile update response:', result);
        
        if (result.success) {
            showNotification('Profile updated successfully!', 'success');
            closeModal('profile-edit-modal');
            
            // Update current patient data
            currentPatient = { ...currentPatient, ...formData };
            localStorage.setItem('currentPatient', JSON.stringify(currentPatient));
            
            // Refresh profile section
            await loadProfileData();
            updatePatientHeader();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('‚ùå Profile update error:', error);
        showNotification('Error updating profile: ' + error.message, 'error');
    } finally {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Save Changes';
        }
    }
}

// Medical Records
async function loadMedicalRecords() {
    try {
        console.log('üìã Loading medical records...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/medical-records`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Medical records response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        const container = document.getElementById('medical-records-list');
        
        if (result.success && result.records && result.records.length > 0) {
            container.innerHTML = result.records.map(record => `
                <div class="record-card scroll-animate">
                    <div class="record-header">
                        <h4>${record.type} - ${formatDate(record.date)}</h4>
                        <span class="record-type">${record.type}</span>
                    </div>
                    <div class="record-details">
                        <p><strong>Doctor:</strong> ${record.doctor?.name || 'N/A'}</p>
                        <p><strong>Diagnosis:</strong> ${record.diagnosis || 'Not specified'}</p>
                        <p><strong>Treatment:</strong> ${record.treatment || 'Not specified'}</p>
                        ${record.notes ? `<p><strong>Notes:</strong> ${record.notes}</p>` : ''}
                    </div>
                    <div class="record-actions">
                        <button class="btn btn-outline btn-sm" onclick="viewRecordDetails('${record._id}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="downloadRecordPDF('${record._id}')">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="no-data">No medical records found</div>';
        }
    } catch (error) {
        console.error('‚ùå Error loading medical records:', error);
        showError('medical-records-list', 'Failed to load medical records.');
    }
}

// Lab Results
async function loadLabResults() {
    try {
        console.log('üî¨ Loading lab results...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/lab-results`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Lab results response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        const container = document.getElementById('lab-results-list');
        
        if (result.success && result.results && result.results.length > 0) {
            container.innerHTML = result.results.map(result => `
                <div class="lab-result-card scroll-animate">
                    <div class="lab-result-header">
                        <h4>${result.testName} - ${formatDate(result.testDate)}</h4>
                        <span class="result-status status-${result.status}">${result.status}</span>
                    </div>
                    <div class="lab-result-details">
                        <p><strong>Test Type:</strong> ${result.testType}</p>
                        <p><strong>Ordered By:</strong> ${result.orderedBy?.name || 'N/A'}</p>
                        ${result.results ? `<p><strong>Results:</strong> ${result.results}</p>` : ''}
                        ${result.notes ? `<p><strong>Notes:</strong> ${result.notes}</p>` : ''}
                    </div>
                    <div class="lab-result-actions">
                        ${result.resultFile ? `
                            <button class="btn btn-outline btn-sm" onclick="downloadLabResult('${result._id}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                        ` : ''}
                        <button class="btn btn-outline btn-sm" onclick="downloadLabResultPDF('${result._id}')">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="no-data">No lab results found</div>';
        }
    } catch (error) {
        console.error('‚ùå Error loading lab results:', error);
        showError('lab-results-list', 'Failed to load lab results.');
    }
}

// Prescriptions
async function loadPrescriptions() {
    try {
        console.log('üíä Loading prescriptions...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/prescriptions`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Prescriptions response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        const container = document.getElementById('prescriptions-list');
        
        if (result.success && result.prescriptions && result.prescriptions.length > 0) {
            container.innerHTML = result.prescriptions.map(prescription => `
                <div class="prescription-card scroll-animate">
                    <div class="prescription-header">
                        <h4>${prescription.medicationName}</h4>
                        <span class="prescription-status status-${prescription.status}">${prescription.status}</span>
                    </div>
                    <div class="prescription-details">
                        <p><strong>Dosage:</strong> ${prescription.dosage}</p>
                        <p><strong>Frequency:</strong> ${prescription.frequency}</p>
                        <p><strong>Prescribed By:</strong> ${prescription.prescribedBy?.name || 'N/A'}</p>
                        <p><strong>Start Date:</strong> ${formatDate(prescription.startDate)}</p>
                        <p><strong>End Date:</strong> ${formatDate(prescription.endDate)}</p>
                        ${prescription.instructions ? `<p><strong>Instructions:</strong> ${prescription.instructions}</p>` : ''}
                    </div>
                    <div class="prescription-actions">
                        ${prescription.status === 'active' ? `
                            <button class="btn btn-outline btn-sm" onclick="requestRefill('${prescription._id}', '${prescription.medicationName}')">
                                <i class="fas fa-redo"></i> Request Refill
                            </button>
                        ` : ''}
                        <button class="btn btn-outline btn-sm" onclick="downloadPrescriptionPDF('${prescription._id}')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="no-data">No prescriptions found</div>';
        }
    } catch (error) {
        console.error('‚ùå Error loading prescriptions:', error);
        showError('prescriptions-list', 'Failed to load prescriptions.');
    }
}

// Billing
async function loadBillingData() {
    try {
        console.log('üí∞ Loading billing data...');
        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/billing`, {
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('üì¶ Billing response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            updateBillingUI(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('‚ùå Error loading billing data:', error);
        showError('billing', 'Failed to load billing information.');
    }
}

function updateBillingUI(data) {
    // Update billing summary
    document.getElementById('current-balance-billing').textContent = `$${(data.currentBalance || 0).toFixed(2)}`;
    document.getElementById('total-paid').textContent = `$${(data.totalPaid || 0).toFixed(2)}`;
    document.getElementById('pending-claims').textContent = data.pendingClaims || 0;
    
    // Remove billing history section as requested
}

// Utility Functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
    } catch (error) {
        return 'Invalid Date';
    }
}

function formatTime(timeString) {
    if (!timeString) return '';
    if (timeString.includes('AM') || timeString.includes('PM')) {
        return timeString;
    }
    try {
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const formattedHour = hour % 12 || 12;
        return `${formattedHour}:${minutes} ${ampm}`;
    } catch (error) {
        return timeString;
    }
}

function showError(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="no-data error">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Something went wrong</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="loadSectionData('${containerId.replace('-list', '')}')">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function triggerScrollAnimations() {
    const scrollElements = document.querySelectorAll('.scroll-animate');
    
    const elementInView = (el) => {
        const elementTop = el.getBoundingClientRect().top;
        return elementTop <= (window.innerHeight || document.documentElement.clientHeight) / 1.2;
    };
    
    scrollElements.forEach((el) => {
        if (elementInView(el)) {
            el.classList.add('animate');
        }
    });
}

// Navigation Functions
async function logout() {
    if (confirm('Are you sure you want to logout?')) {
        try {
            const logoutBtn = document.querySelector('.logout-btn');
            const originalText = logoutBtn.innerHTML;
            logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
            logoutBtn.disabled = true;

            // Clear localStorage
            localStorage.removeItem('currentPatient');
            localStorage.removeItem('authToken');
            
            showNotification('Logged out successfully', 'success');
            
            // Redirect to portal
            setTimeout(() => {
                window.location.href = 'patient-portal.html';
            }, 1000);
        } catch (error) {
            console.error('‚ùå Logout error:', error);
            localStorage.removeItem('currentPatient');
            localStorage.removeItem('authToken');
            window.location.href = 'patient-portal.html';
        }
    }
}

async function refreshDashboard() {
    console.log('üîÑ Refreshing dashboard...');
    showNotification('Refreshing dashboard...', 'info');
    await loadOverviewData();
    triggerScrollAnimations();
    showNotification('Dashboard updated', 'success');
}

// Booking functionality
function bookAppointment() {
    showBookingModal();
}

function showBookingModal() {
    const modal = document.getElementById('booking-modal');
    const today = new Date();
    const minDate = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
    
    modal.style.display = 'block';
    document.getElementById('booking-form').reset();
    loadAvailableDepartments();
}

function closeBookingModal() {
    document.getElementById('booking-modal').style.display = 'none';
}

// Load available departments from API
async function loadAvailableDepartments() {
    try {
        console.log('üè• Loading available departments...');
        const response = await fetch(`${API_BASE}/departments`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        const departmentSelect = document.getElementById('booking-department');
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.departments && result.departments.length > 0) {
                // Store departments globally
                availableDepartments = result.departments;
                
                // Sort departments to ensure consultation is first
                const sortedDepartments = [...availableDepartments].sort((a, b) => {
                    if (a.name.toLowerCase() === 'consultation') return -1;
                    if (b.name.toLowerCase() === 'consultation') return 1;
                    return a.name.localeCompare(b.name);
                });
                
                departmentSelect.innerHTML = '<option value="">Select a department</option>' +
                    sortedDepartments.map(dept => 
                        `<option value="${dept._id}">${dept.name}${dept.description ? ` - ${dept.description}` : ''}</option>`
                    ).join('');
            } else {
                // Fallback to default departments if API fails
                loadDefaultDepartments();
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('‚ùå Error loading departments:', error);
        // Fallback to default departments
        loadDefaultDepartments();
    }
}

// Fallback function to load default departments
function loadDefaultDepartments() {
    console.log('üìã Loading default departments...');
    const departmentSelect = document.getElementById('booking-department');
    
    const defaultDepartments = [
        { _id: 'consultation', name: 'General Consultation', description: 'First point of contact for all health concerns' },
        { _id: 'cardiology', name: 'Cardiology', description: 'Heart and cardiovascular care' },
        { _id: 'neurology', name: 'Neurology', description: 'Brain and nervous system disorders' },
        { _id: 'pediatrics', name: 'Pediatrics', description: 'Children\'s healthcare' },
        { _id: 'orthopedics', name: 'Orthopedics', description: 'Bones, joints, and muscles' },
        { _id: 'ophthalmology', name: 'Ophthalmology', description: 'Eye care and vision health' },
        { _id: 'ent', name: 'ENT', description: 'Ear, nose, and throat conditions' },
        { _id: 'pulmonology', name: 'Pulmonology', description: 'Respiratory and lung health' },
        { _id: 'oncology', name: 'Oncology', description: 'Cancer diagnosis and treatment' },
        { _id: 'hematology', name: 'Hematology', description: 'Blood disorders and diseases' },
        { _id: 'gastroenterology', name: 'Gastroenterology', description: 'Digestive system health' },
        { _id: 'dermatology', name: 'Dermatology', description: 'Skin conditions and care' },
        { _id: 'dentistry', name: 'Dentistry', description: 'Oral health and dental care' },
        { _id: 'psychiatry', name: 'Psychiatry', description: 'Mental health and wellness' },
        { _id: 'obgyn', name: 'Obstetrics & Gynecology', description: 'Women\'s health and childbirth' },
        { _id: 'urology', name: 'Urology', description: 'Urinary system and male reproductive health' },
        { _id: 'physical-therapy', name: 'Physical Therapy', description: 'Rehabilitation and mobility' },
        { _id: 'pathology', name: 'Pathology', description: 'Laboratory testing and diagnosis' },
        { _id: 'radiology', name: 'Radiology', description: 'Medical imaging and diagnostics' },
        { _id: 'geriatrics', name: 'Geriatrics', description: 'Elderly care and aging health' }
    ];
    
    availableDepartments = defaultDepartments;
    
    departmentSelect.innerHTML = '<option value="">Select a department</option>' +
        defaultDepartments.map(dept => 
            `<option value="${dept._id}">${dept.name}${dept.description ? ` - ${dept.description}` : ''}</option>`
        ).join('');
}

// Handle department selection change
async function handleDepartmentChange() {
    const departmentId = this.value;
    const doctorSelect = document.getElementById('booking-doctor');
    
    if (!departmentId) {
        // Reset doctor selection if no department is selected
        doctorSelect.innerHTML = '<option value="">Any available doctor</option>';
        return;
    }
    
    try {
        console.log(`üë®‚Äç‚öïÔ∏è Loading doctors for department: ${departmentId}`);
        
        // Show loading state
        doctorSelect.innerHTML = '<option value="">Loading doctors...</option>';
        
        const response = await fetch(`${API_BASE}/departments/${departmentId}/doctors`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.doctors && result.doctors.length > 0) {
                doctorSelect.innerHTML = '<option value="">Any available doctor</option>' +
                    result.doctors.map(doctor => 
                        `<option value="${doctor._id}">Dr. ${doctor.name} - ${doctor.specialization || 'General Practitioner'}</option>`
                    ).join('');
            } else {
                doctorSelect.innerHTML = '<option value="">No specific doctors available</option>';
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('‚ùå Error loading doctors:', error);
        doctorSelect.innerHTML = '<option value="">Any available doctor</option>';
    }
}

async function handleBookingSubmit(event) {
    event.preventDefault();
    
    const appointmentData = {
        departmentId: document.getElementById('booking-department').value,
        doctorId: document.getElementById('booking-doctor').value || null,
        appointmentDate: document.getElementById('booking-date').value,
        appointmentTime: document.getElementById('booking-time').value,
        type: document.getElementById('booking-type').value,
        consultationType: document.getElementById('booking-consultation-type').value,
        reason: document.getElementById('booking-reason').value,
        symptoms: document.getElementById('booking-symptoms').value.split(',').map(s => s.trim()).filter(s => s),
        priority: document.getElementById('booking-priority').value
    };

    try {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';
        submitBtn.disabled = true;

        const response = await fetch(`${API_BASE}/patients/${currentPatient.patientId}/appointments/book`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(appointmentData)
        });

        const result = await response.json();
        console.log('üì¶ Booking response:', result);
        
        if (result.success) {
            showNotification('Appointment booked successfully!', 'success');
            closeBookingModal();
            await loadSectionData('appointments');
            await loadSectionData('overview');
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('‚ùå Booking error:', error);
        showNotification('Error booking appointment: ' + error.message, 'error');
    } finally {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Book Appointment';
        }
    }
}

// Mobile menu functionality
function initMobileMenu() {
    const sidebar = document.querySelector('.dashboard-sidebar');
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'mobile-menu-toggle';
    toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
    toggleBtn.setAttribute('aria-label', 'Toggle menu');
    
    // Insert toggle button at the beginning of the body
    document.body.appendChild(toggleBtn);
    
    toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-mobile-hidden');
        const icon = this.querySelector('i');
        if (sidebar.classList.contains('sidebar-mobile-hidden')) {
            icon.className = 'fas fa-bars';
        } else {
            icon.className = 'fas fa-times';
        }
    });
    
    // Close mobile menu when clicking on a nav link
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('sidebar-mobile-hidden');
                toggleBtn.querySelector('i').className = 'fas fa-bars';
            }
        });
    });
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !toggleBtn.contains(event.target) &&
            !sidebar.classList.contains('sidebar-mobile-hidden')) {
            sidebar.classList.add('sidebar-mobile-hidden');
            toggleBtn.querySelector('i').className = 'fas fa-bars';
        }
    });
    
    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            sidebar.classList.remove('sidebar-mobile-hidden');
            toggleBtn.style.display = 'none';
        } else {
            sidebar.classList.add('sidebar-mobile-hidden');
            toggleBtn.style.display = 'block';
        }
    });
    
    // Hide toggle button on desktop initially
    if (window.innerWidth > 768) {
        toggleBtn.style.display = 'none';
    }
}

// Other functionality stubs
function requestLabWork() {
    showNotification('Lab work request feature coming soon!', 'info');
}

function requestNewPrescription() {
    showNotification('New prescription request feature coming soon!', 'info');
}

function requestRefill(prescriptionId, medication) {
    showNotification(`Refill request for ${medication} submitted!`, 'success');
}

function downloadRecords() {
    downloadMedicalRecordsPDF();
}

function makePayment() {
    showPaymentModal();
}

function rescheduleAppointment(appointmentId) {
    showNotification('Reschedule feature coming soon!', 'info');
}

function cancelAppointment(appointmentId) {
    if (confirm('Are you sure you want to cancel this appointment?')) {
        showNotification('Appointment cancellation feature coming soon!', 'info');
    }
}

function viewRecordDetails(recordId) {
    showNotification('View record details feature coming soon!', 'info');
}

function downloadLabResult(resultId) {
    showNotification('Download lab result feature coming soon!', 'info');
}

function payBill(billId, amount) {
    paySpecificBill(billId, amount);
}

function viewBill(billId) {
    showNotification('View bill details feature coming soon!', 'info');
}

// Initialize scroll animations on scroll
window.addEventListener('scroll', triggerScrollAnimations);
    </script>
</body>
</html>