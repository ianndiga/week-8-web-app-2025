<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal - Jijue Hospital</title>
    <link rel="stylesheet" href="patient-portal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <span class="logo-icon">üè•</span>
                <h1>Jijue Hospital</h1>
            </div>
            <button class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="services.html">Services</a></li>
                    <li><a href="doctors.html">Our Doctors</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Portal Hero Section -->
    <section class="portal-hero">
        <div class="container">
            <h2 class="fade-in">Patient Portal</h2>
            <p class="fade-in">Access your health information and manage your care online with our secure patient portal</p>
        </div>
    </section>

    <!-- Portal Content -->
    <div class="container">
        <div class="portal-container">
            <!-- Sidebar -->
            <div class="portal-sidebar">
                <h3 style="color: var(--primary); margin-bottom: 25px; font-size: 1.4rem; font-weight: 700;">Portal Features</h3>
                <ul style="list-style: none;">
                    <li style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s ease;" class="scroll-animate">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 1.5rem; color: var(--primary);">üìÖ</div>
                            <div>
                                <strong>Appointments</strong>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">Book and manage visits</p>
                            </div>
                        </div>
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s ease;" class="scroll-animate">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 1.5rem; color: var(--primary);">üìã</div>
                            <div>
                                <strong>Medical Records</strong>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">Access test results</p>
                            </div>
                        </div>
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s ease;" class="scroll-animate">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 1.5rem; color: var(--primary);">üíä</div>
                            <div>
                                <strong>Prescriptions</strong>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">Request refills</p>
                            </div>
                        </div>
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s ease;" class="scroll-animate">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 1.5rem; color: var(--primary);">üí∞</div>
                            <div>
                                <strong>Billing</strong>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">View and pay bills</p>
                            </div>
                        </div>
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s ease;" class="scroll-animate">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 1.5rem; color: var(--primary);">üìû</div>
                            <div>
                                <strong>Messaging</strong>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">Contact your care team</p>
                            </div>
                        </div>
                    </li>
                </ul>

                <div class="portal-stats">
                    <div class="stat-card scroll-animate">
                        <div class="stat-number">5,000+</div>
                        <div class="stat-label">Active Patients</div>
                    </div>
                    <div class="stat-card scroll-animate">
                        <div class="stat-number">24/7</div>
                        <div class="stat-label">Access</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="portal-main">
                <!-- Login Form -->
                <div class="login-section" id="login">
                    <h3>Login to Your Account</h3>
                    <p style="color: var(--gray); margin-bottom: 20px;">Use your email or phone number to access your account</p>
                    
                    <!-- Login Identifier Toggle -->
                    <div class="login-identifier-toggle">
                        <button id="email-toggle" class="active">Email</button>
                        <button id="phone-toggle">Phone Number</button>
                    </div>
                    
                    <form id="login-form">
                        <!-- Email Input Group -->
                        <div class="identifier-input-group active" id="email-group">
                            <div class="form-group">
                                <label for="email">
                                    <i class="fas fa-envelope" style="margin-right: 8px;"></i>
                                    Email Address
                                </label>
                                <input type="email" id="email" class="form-control" placeholder="Enter your email address" required>
                            </div>
                        </div>
                        
                        <!-- Phone Number Input Group -->
                        <div class="identifier-input-group" id="phone-group">
                            <div class="form-group">
                                <label for="phone">
                                    <i class="fas fa-phone" style="margin-right: 8px;"></i>
                                    Phone Number
                                </label>
                                <div class="phone-input-container">
                                    <span class="country-code">+254</span>
                                    <input type="tel" id="phone" class="form-control phone-input" placeholder="712 345 678" required maxlength="9">
                                </div>
                            </div>
                        </div>
                        
                        <!-- ID Number Field (Always Required) -->
                        <div class="form-group">
                            <label for="idNumber">
                                <i class="fas fa-id-card" style="margin-right: 8px;"></i>
                                ID Number
                            </label>
                            <input type="text" id="idNumber" class="form-control" placeholder="Enter your national ID number" required maxlength="20">
                        </div>
                        
                        <!-- Error and Success Messages -->
                        <div class="error-message" id="login-error">
                            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                            The credentials you entered are incorrect. Don't have an account?
                            <a href="patient-registration.html" style="margin-left: 5px; color: var(--primary); font-weight: 600;">Sign up</a>
                        </div>
                        <div class="success-message" id="login-success">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            Login successful! Redirecting to your dashboard...
                        </div>
                        
                        <!-- Login Options -->
                        <div class="login-options">
                            <div class="remember-me">
                                <input type="checkbox" id="remember">
                                <label for="remember" style="margin: 0; font-weight: normal;">Remember me</label>
                            </div>
                            <div>
                                <a href="#" class="forgot-password" id="forgot-id">
                                    <i class="fas fa-question-circle" style="margin-right: 5px;"></i>
                                    Forgot ID Number?
                                </a>
                            </div>
                        </div>
                        
                        <!-- Login Button -->
                        <button type="submit" class="btn login-btn" style="width: 100%;">
                            <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>
                            Login to Portal
                        </button>
                    </form>
                    
                    <!-- Sign Up Section -->
                    <div class="signup-section">
                        <div class="divider">
                            <span>Don't have an account?</span>
                        </div>
                        <a href="patient-registration.html" class="btn btn-secondary signup-btn">
                            <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
                            Sign Up Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Jijue Hospital</h3>
                    <p>Providing quality healthcare services with compassion and excellence since 2025. Your health is our priority.</p>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="services.html">Services</a></li>
                        <li><a href="doctors.html">Our Doctors</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="patient-portal.html">Patient Portal</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Info</h3>
                    <ul class="footer-links">
                        <li><a href="https://maps.google.com/?q=Health+Street,Nairobi+City,Kenya" target="_blank">üìç Health Street, Nairobi City</a></li>
                        <li><a href="tel:+254115947353">üìû +254115947353</a></li>
                        <li><a href="mailto:info@jijuehospital.com">‚úâÔ∏è info@jijuehospital.com</a></li>
                        <li>üïí Mon-Fri: 8am-6pm, Sat: 9am-1pm</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Emergency</h3>
                    <p>For medical emergencies, please call our 24/7 emergency line:</p>
                    <h3 style="color: var(--accent); margin-top: 15px;">
                        <a href="tel:+254115947353" style="color: var(--accent); text-decoration: none; font-size: 1.3rem;">+254115947353</a>
                    </h3>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 Jijue Hospital. All rights reserved. | <a href="privacy.html" style="color: #aaa;">Privacy Policy</a> | <a href="terms.html" style="color: #aaa;">Terms of Service</a></p>
            </div>
        </div>
    </footer>

    <script>
        // Mobile Navigation Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const backBtn = document.querySelector('.back-btn');
            const navMenu = document.querySelector('nav ul');
            
            // ‚úÖ FIX: Use relative path for API
            const API_BASE = 'http://localhost:5000/api';
            
            // ‚úÖ ADD: Connection test function
            async function testBackendConnection() {
                try {
                    console.log('üîç Testing backend connection...');
                    const response = await fetch(`${API_BASE}/health`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Backend connected:', data.message);
                        return true;
                    } else {
                        console.error('‚ùå Backend health check failed');
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Cannot connect to backend:', error);
                    return false;
                }
            }

            // Test connection on page load
            testBackendConnection();

            // Back button functionality - FIXED: Always go to home page
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    // Always redirect to home page
                    window.location.href = 'index.html';
                });
            }

            // Email/Phone Toggle Functionality
            const emailToggle = document.getElementById('email-toggle');
            const phoneToggle = document.getElementById('phone-toggle');
            const emailGroup = document.getElementById('email-group');
            const phoneGroup = document.getElementById('phone-group');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            
            if (emailToggle && phoneToggle) {
                emailToggle.addEventListener('click', function() {
                    emailToggle.classList.add('active');
                    phoneToggle.classList.remove('active');
                    emailGroup.classList.add('active');
                    phoneGroup.classList.remove('active');
                    emailInput.required = true;
                    phoneInput.required = false;
                });
                
                phoneToggle.addEventListener('click', function() {
                    phoneToggle.classList.add('active');
                    emailToggle.classList.remove('active');
                    phoneGroup.classList.add('active');
                    emailGroup.classList.remove('active');
                    phoneInput.required = true;
                    emailInput.required = false;
                });
            }

            // Login Form Submission
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const loginSuccess = document.getElementById('login-success');

            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Determine which identifier is active
                    const isEmailLogin = emailToggle.classList.contains('active');
                    const identifier = isEmailLogin ? emailInput.value : `+254${phoneInput.value}`;
                    const idNumber = document.getElementById('idNumber').value;
                    
                    // Reset states
                    if (loginError) loginError.style.display = 'none';
                    if (loginSuccess) loginSuccess.style.display = 'none';
                    
                    const identifierField = isEmailLogin ? emailInput : phoneInput;
                    const idNumberField = document.getElementById('idNumber');
                    
                    if (identifierField) identifierField.classList.remove('error');
                    if (idNumberField) idNumberField.classList.remove('error');
                    
                    // Simple validation
                    if (identifier && idNumber) {
                        // Show loading state
                        const submitBtn = loginForm.querySelector('.login-btn');
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                        
                        try {
                            console.log('üîÑ Attempting login to:', `${API_BASE}/patients/login`);
                            
                            // Send login request to backend API
                            const response = await fetch(`${API_BASE}/patients/login`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ 
                                    identifier: identifier.trim(),
                                    idNumber: idNumber.trim(),
                                    identifierType: isEmailLogin ? 'email' : 'phone'
                                })
                            });

                            console.log('üì° Login response status:', response.status);

                            const result = await response.json();
                            console.log('üì¶ Login response:', result);

                            if (result.success) {
                                // Successful login
                                if (loginSuccess) {
                                    loginSuccess.style.display = 'block';
                                    loginSuccess.textContent = result.message || 'Login successful! Redirecting...';
                                }
                                
                                // Store patient data in localStorage
                                localStorage.setItem('currentPatient', JSON.stringify(result.patient));
                                // Store auth token if provided
                                if (result.token) {
                                    localStorage.setItem('authToken', result.token);
                                }
                                
                                // Redirect to dashboard after a delay
                                setTimeout(() => {
                                    window.location.href = 'patient-dashboard.html';
                                }, 1500);
                            } else {
                                // Failed login
                                if (loginError) {
                                    loginError.textContent = result.message || 'Invalid credentials. Don\'t have an account? ';
                                    loginError.innerHTML = '<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>' + 
                                        (result.message || 'Invalid credentials. Don\'t have an account?') + 
                                        ' <a href="patient-registration.html" style="margin-left: 5px; color: var(--primary); font-weight: 600;">Sign up</a>';
                                    loginError.style.display = 'block';
                                }
                                
                                if (identifierField) identifierField.classList.add('error');
                                if (idNumberField) idNumberField.classList.add('error');
                                
                                // Add shake animation to form
                                loginForm.classList.add('shake');
                                setTimeout(() => {
                                    loginForm.classList.remove('shake');
                                }, 500);
                                
                                // Scroll to error message
                                if (loginError) {
                                    loginError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }
                        } catch (error) {
                            console.error('Login error:', error);
                            if (loginError) {
                                loginError.textContent = 'Cannot connect to server. Please try again later.';
                                loginError.style.display = 'block';
                            }
                            
                            // Fallback to localStorage if API is not available
                            console.log('API not available, checking localStorage...');
                            
                            // Get stored registration data from localStorage
                            const storedPatients = JSON.parse(localStorage.getItem('registeredPatients') || '[]');
                            const foundPatient = storedPatients.find(patient => {
                                if (isEmailLogin) {
                                    return patient.email === identifier && patient.idNumber === idNumber;
                                } else {
                                    return patient.phone === identifier && patient.idNumber === idNumber;
                                }
                            });
                            
                            if (foundPatient) {
                                // Successful login with localStorage fallback
                                if (loginSuccess) {
                                    loginSuccess.style.display = 'block';
                                    loginSuccess.textContent = 'Login successful! Redirecting...';
                                }
                                
                                // Store current session
                                localStorage.setItem('currentPatient', JSON.stringify(foundPatient));
                                
                                // Redirect to dashboard after a delay
                                setTimeout(() => {
                                    window.location.href = 'patient-dashboard.html';
                                }, 1500);
                            }
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    } else {
                        // Validation failed
                        if (loginError) {
                            loginError.textContent = 'Please enter all required fields';
                            loginError.style.display = 'block';
                        }
                        if (!identifier && identifierField) identifierField.classList.add('error');
                        if (!idNumber && idNumberField) idNumberField.classList.add('error');
                    }
                });
            }

            // Forgot ID Number functionality
            const forgotIdLink = document.getElementById('forgot-id');
            if (forgotIdLink) {
                forgotIdLink.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const isEmailLogin = emailToggle.classList.contains('active');
                    const identifier = isEmailLogin ? emailInput.value : `+254${phoneInput.value}`;
                    
                    if (!identifier) {
                        alert(`Please enter your ${isEmailLogin ? 'email address' : 'phone number'} first to retrieve your ID number.`);
                        if (isEmailLogin) {
                            emailInput.focus();
                        } else {
                            phoneInput.focus();
                        }
                        return;
                    }
                    
                    // Show loading state
                    const originalText = forgotIdLink.innerHTML;
                    forgotIdLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                    forgotIdLink.style.pointerEvents = 'none';
                    
                    try {
                        console.log('üîç Forgot ID request to:', `${API_BASE}/patients/forgot-id`);
                        
                        // Try to check with backend API first
                        const response = await fetch(`${API_BASE}/patients/forgot-id`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                identifier: identifier.trim(),
                                identifierType: isEmailLogin ? 'email' : 'phone'
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                alert(`Your ID number has been sent to ${identifier}.\n\nFor security reasons, please check your ${isEmailLogin ? 'email inbox' : 'phone'} for your ID number.`);
                            } else {
                                alert(`No account found with ${isEmailLogin ? 'email' : 'phone number'}: ${identifier}\n\nPlease check your information or register as a new patient.`);
                            }
                        } else {
                            // Fallback to localStorage if API endpoint doesn't exist
                            throw new Error('API endpoint not available');
                        }
                    } catch (error) {
                        console.log('API not available, checking localStorage...');
                        // Check if identifier exists in stored patients (fallback)
                        const storedPatients = JSON.parse(localStorage.getItem('registeredPatients') || '[]');
                        const foundPatient = storedPatients.find(patient => {
                            if (isEmailLogin) {
                                return patient.email === identifier;
                            } else {
                                return patient.phone === identifier;
                            }
                        });
                        
                        if (foundPatient) {
                            alert(`Your ID number has been sent to ${identifier}.\n\nFor security reasons, please check your ${isEmailLogin ? 'email inbox' : 'phone'} for your ID number.`);
                        } else {
                            alert(`No account found with ${isEmailLogin ? 'email' : 'phone number'}: ${identifier}\n\nPlease check your information or register as a new patient.`);
                        }
                    } finally {
                        forgotIdLink.innerHTML = originalText;
                        forgotIdLink.style.pointerEvents = 'auto';
                    }
                });
            }

            // Check for registration success parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('registration') === 'success') {
                const name = urlParams.get('name');
                if (name) {
                    // Show success message
                    const successMessage = document.createElement('div');
                    successMessage.className = 'success-message';
                    successMessage.style.cssText = `
                        background: #d4edda;
                        color: #155724;
                        padding: 12px 16px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        border: 1px solid #c3e6cb;
                        display: block;
                    `;
                    successMessage.innerHTML = `
                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                        Welcome ${decodeURIComponent(name)}! Your registration was successful. Please login to access your account.
                    `;
                    
                    const loginForm = document.getElementById('login-form');
                    if (loginForm) {
                        loginForm.insertBefore(successMessage, loginForm.firstChild);
                        
                        // Scroll to success message
                        setTimeout(() => {
                            successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    }
                }
            }

            // Scroll animations
            const scrollElements = document.querySelectorAll('.scroll-animate, .fade-in');
            
            const elementInView = (el, dividend = 1) => {
                const elementTop = el.getBoundingClientRect().top;
                return (
                    elementTop <= (window.innerHeight || document.documentElement.clientHeight) / dividend
                );
            };
            
            const displayScrollElement = (element) => {
                element.classList.add('animate');
            };
            
            const handleScrollAnimation = () => {
                scrollElements.forEach((el) => {
                    if (elementInView(el, 1.2)) {
                        displayScrollElement(el);
                    }
                });
            };
            
            // Initial check
            handleScrollAnimation();
            
            // Listen for scroll
            window.addEventListener('scroll', () => {
                handleScrollAnimation();
            });

            // Header scroll effect
            window.addEventListener('scroll', function() {
                const header = document.querySelector('header');
                if (header && window.scrollY > 50) {
                    header.style.boxShadow = '0 5px 20px rgba(0,0,0,0.1)';
                    header.style.background = 'rgba(255,255,255,0.95)';
                    header.style.backdropFilter = 'blur(10px)';
                } else if (header) {
                    header.style.boxShadow = '0 2px 15px rgba(0,0,0,0.1)';
                    header.style.background = 'white';
                    header.style.backdropFilter = 'none';
                }
            });

            // Animate hero elements on load
            setTimeout(() => {
                document.querySelectorAll('.fade-in').forEach(el => {
                    el.classList.add('animate');
                });
            }, 300);
        });

        // Global API Base - ‚úÖ FIXED: Use relative path
        const API_BASE = '/api';

        // Enhanced Appointment Booking Function
        const bookAppointment = async (appointmentData) => {
            try {
                const token = localStorage.getItem('authToken');
                const currentPatient = JSON.parse(localStorage.getItem('currentPatient'));
                
                if (!currentPatient) {
                    alert('Please login to book an appointment.');
                    window.location.href = 'patient-portal.html';
                    return null;
                }

                // Use current patient's ID if not provided
                const finalAppointmentData = {
                    ...appointmentData,
                    patientId: currentPatient.patientId || appointmentData.patientId
                };

                console.log('üîÑ Booking appointment:', finalAppointmentData);

                const response = await fetch(`${API_BASE}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(finalAppointmentData)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to book appointment');
                }

                return data;
            } catch (error) {
                console.error('Error booking appointment:', error);
                throw error;
            }
        };

        // Quick Book Appointment Function (for simple bookings)
        const quickBookAppointment = async (doctorId, date, time, reason = 'General consultation') => {
            try {
                const appointmentData = {
                    doctorId,
                    appointmentDate: date,
                    appointmentTime: time,
                    type: 'consultation',
                    consultationType: 'in-person',
                    reason: reason,
                    symptoms: [],
                    priority: 'medium',
                    duration: 30
                };

                const result = await bookAppointment(appointmentData);
                
                if (result && result.success) {
                    alert('Appointment booked successfully!');
                    return result;
                } else {
                    throw new Error(result?.message || 'Booking failed');
                }
            } catch (error) {
                console.error('Quick booking error:', error);
                alert('Error: ' + error.message);
                throw error;
            }
        };

        // Get Available Doctors
        const getAvailableDoctors = async (specialization = '') => {
            try {
                const response = await fetch(`${API_BASE}/doctors/available${specialization ? `?specialization=${specialization}` : ''}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch doctors');
                }

                return data;
            } catch (error) {
                console.error('Error fetching doctors:', error);
                throw error;
            }
        };

        // Get Doctor Availability
        const getDoctorAvailability = async (doctorId, date) => {
            try {
                const response = await fetch(`${API_BASE}/doctors/${doctorId}/availability?date=${date}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch availability');
                }

                return data;
            } catch (error) {
                console.error('Error fetching availability:', error);
                throw error;
            }
        };

        // Get Patient Appointments
        const getPatientAppointments = async (patientId, filters = {}) => {
            try {
                const token = localStorage.getItem('authToken');
                const queryParams = new URLSearchParams(filters).toString();
                
                const response = await fetch(`${API_BASE}/appointments/patient/${patientId}?${queryParams}`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch appointments');
                }

                return data;
            } catch (error) {
                console.error('Error fetching appointments:', error);
                throw error;
            }
        };

        // Cancel Appointment
        const cancelAppointment = async (appointmentId, reason = 'Patient requested cancellation') => {
            try {
                const token = localStorage.getItem('authToken');
                
                const response = await fetch(`${API_BASE}/appointments/${appointmentId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        status: 'cancelled',
                        notes: reason
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to cancel appointment');
                }

                return data;
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                throw error;
            }
        };

        // Reschedule Appointment
        const rescheduleAppointment = async (appointmentId, newDate, newTime) => {
            try {
                const token = localStorage.getItem('authToken');
                
                const response = await fetch(`${API_BASE}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        appointmentDate: newDate,
                        appointmentTime: newTime
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to reschedule appointment');
                }

                return data;
            } catch (error) {
                console.error('Error rescheduling appointment:', error);
                throw error;
            }
        };

        // Get Patient Overview/Dashboard Data
        const getPatientOverview = async (patientId) => {
            try {
                const token = localStorage.getItem('authToken');
                
                const response = await fetch(`${API_BASE}/patients/${patientId}/overview`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch patient overview');
                }

                return data;
            } catch (error) {
                console.error('Error fetching patient overview:', error);
                throw error;
            }
        };

        // Get Patient Profile
        const getPatientProfile = async (patientId) => {
            try {
                const token = localStorage.getItem('authToken');
                
                const response = await fetch(`${API_BASE}/patients/profile/${patientId}`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch patient profile');
                }

                return data;
            } catch (error) {
                console.error('Error fetching patient profile:', error);
                throw error;
            }
        };

        // Get Auth Token Helper
        const getAuthToken = () => {
            return localStorage.getItem('authToken') || '';
        };

        // Check if user is authenticated
        const isAuthenticated = () => {
            return !!localStorage.getItem('currentPatient') && !!localStorage.getItem('authToken');
        };

        // Require authentication for protected actions
        const requireAuth = (action) => {
            if (!isAuthenticated()) {
                alert('Please login to access this feature.');
                window.location.href = 'patient-portal.html';
                return false;
            }
            return true;
        };

        // Logout function
        const logout = () => {
            localStorage.removeItem('currentPatient');
            localStorage.removeItem('authToken');
            window.location.href = 'patient-portal.html';
        };

        // Check authentication on protected pages
        const checkAuth = () => {
            if (!isAuthenticated() && !window.location.href.includes('patient-portal.html')) {
                window.location.href = 'patient-portal.html';
                return false;
            }
            return true;
        };

        // Global utility functions
        window.PatientPortal = {
            bookAppointment,
            quickBookAppointment,
            getAvailableDoctors,
            getDoctorAvailability,
            getPatientAppointments,
            cancelAppointment,
            rescheduleAppointment,
            getPatientOverview,
            getPatientProfile,
            getAuthToken,
            isAuthenticated,
            requireAuth,
            logout,
            checkAuth,
            API_BASE
        };

        console.log('üöÄ Patient Portal API functions loaded successfully');
    </script>
</body>
</html>